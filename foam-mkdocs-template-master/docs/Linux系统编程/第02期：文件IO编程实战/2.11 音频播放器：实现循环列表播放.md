# 2.11 音频播放器：实现循环列表播放

```c
#include <unistd.h>
#include <fcntl.h>
#include <sys/types.h>
#include <sys/stat.h>
#include <stdio.h>

#include <sys/ioctl.h>
#include <linux/soundcard.h>
#include <dirent.h>	//用到了dir操作
#inclufe <string.h>

char sonlist[10][40];
int song_count;

void ls_wav_file(void)
{
	DIR * dir_ptr;
	strucr dirnet *entry_ptr;
	dir_ptr = opendir(".");
	int i;
	while (entry_ptr = readdir(dir_ptr)!=NULL)
	{
		if (srtcmp(entry_ptr->d_name + stelen(entry_ptr->d_name)-4 ,".wav")!=0)
			continue;	// 如果文件名最后4个不知是.wav就跳过
			
		strcpy(sonlist[song_count++],entry_ptr->d_name);
		printf("%s\n",entry_ptr->d_name);
	}
	printf("------song list------");
	for (i=0;i<song_count;i++)
	{
		printf("%s\n",songlist[i]);
	}
	printf("------song list------");
}
int main (void)
{
	int dst_fd;
	int play_count = 0;
	dst_fd = open ("/dev/dsp", O_WRONLY, 0666); /*open dsp*/
	if (dst_fd == -1)
	{
		perror ("open /dev/dsp error!");
		return -1;
	}

	int rate = 44100;
	ioctl (dst_fd, SNDCTL_DSP_SPEED, &rate);	//采样率
	int channels = 2;
	ioctl (dst_fd, SNDCTL_DSP_CHANNELS, &channels);	//声道
	int format = 16;
	ioctl (dst_fd, SNDCTL_DSP_SETFMT, &format);	//采样模式
while(1){//列表无限循环
	int src_fd;
	src_fd  = open ("songlist[play_count++]", O_RDONLY, 0666);//打开音乐裂变
	if (src_fd == -1)
	{
		perror ("open wav file failed!");
		close (dst_fd);
		return -2;
	}
	
	printf("playing %s...\n",songlist[play_count]);
	int read_count;
	char buf[1024];
	while ((read_count = read(src_fd, buf, 1024)) > 0)
	{
		if (write(dst_fd, buf, read_count) != read_count)
		{
			perror("write /dev/dsp error");
			return -3;
		}
	}
	if (read_count < 0)
	{
		perror("read wav file error");
		return -4;
	}
	if (play_count == song_count)
		play_count=0;
	 
	close(src_fd);
	close(dst_fd);
}
	return 0;
}

```