# 5.8 FIFO应用：服务端与客户端通信

## 服务端、客户端进程通过FIFO实现双向通信
需要两个fifo
client.c
```c
/************************************************
*      Filename: client.c
*        Author: litao.wang
*    Bug Report: 3284757626@qq.com
*   Description: 
*        Create: 2019-06-14 06:36:55
* Last Modified: 2019-07-18 18:38:26
*************************************************/
#include <stdio.h>
#include <stdlib.h>
#include <unistd.h>
#include <string.h>
#include <fcntl.h>
#include <sys/stat.h>
#include <sys/types.h>

#define FIFO_SERVER "fifo_server"	//往服务器端写的FIFO名
#define FIFO_CLIENT "fifo_client"	//往客户端写的F IFO名

int main (void)
{
	mkfifo (FIFO_SERVER, 0644);	//创建两个管道
	mkfifo (FIFO_CLIENT, 0644);	

	int ret_from_fork;
	ret_from_fork = fork ();		//创建子进程
	if (ret_from_fork == -1)
	{
		perror ("fork");
		exit (EXIT_FAILURE);
	}
	else if (ret_from_fork == 0)  // child process: write
	{  
		int fd_fifo_write;
		fd_fifo_write = open (FIFO_SERVER, O_WRONLY);
		char buf[100];
		while (1)
		{
			memset (buf, 0, 100);
			scanf ("%s", buf);
			write (fd_fifo_write, buf, strlen (buf) + 1);
		}
		_exit (EXIT_SUCCESS);
	}
	else              			// parent process: read
	{
		int fd_fifo_read;
		fd_fifo_read = open (FIFO_CLIENT, O_RDONLY);
		char buf[100];
		while (1)
		{
			memset (buf, 0, 100);
			if (read (fd_fifo_read, buf, 100) > 0)
				printf ("server: %s\n", buf);
		}
		exit (EXIT_SUCCESS);
	}
	return 0;
}

```
server.c

```c
/************************************************
*      Filename: server.c
*        Author: litao.wang
*    Bug Report: 3284757626@qq.com
*   Description: 
*        Create: 2019-06-14 06:36:55
* Last Modified: 2019-07-18 18:38:26
*************************************************/
#include <stdio.h>
#include <stdlib.h>
#include <unistd.h>
#include <string.h>
#include <fcntl.h>
#include <sys/stat.h>
#include <sys/types.h>

#define FIFO_SERVER "fifo_server"//往服务器端写的FIFO名
#define FIFO_CLIENT "fifo_client"//往客户端写的FIFO名

int main (void)
{
	mkfifo (FIFO_SERVER, 0644);//创建两个管道
	mkfifo (FIFO_CLIENT, 0644);

	int ret_from_fork;
	ret_from_fork = fork ();//创建子进程
	if (ret_from_fork == -1)
	{
		perror ("fork");
		exit (EXIT_FAILURE);
	}
	else if (ret_from_fork == 0) //child process: write
	{
		int fd_fifo_write;
		fd_fifo_write = open (FIFO_CLIENT, O_WRONLY);
		char buf[100];
		while (1)
		{
			memset (buf, 0, 100);
			scanf ("%s", buf);
			//键盘输入字符串到buf
			write (fd_fifo_write, buf, strlen (buf) + 1);
			//buf数据发送到客户端
		}
		_exit (EXIT_SUCCESS);
	}
	else
	{                         //parent process: read
		int fd_fifo_read;
		fd_fifo_read = open (FIFO_SERVER, O_RDONLY);
		//打开server管道
		
		char buf[100];
		while (1)
		{
			memset (buf, 0, 100);
			if (read (fd_fifo_read, buf, 100) > 0)	
			//读server端FIFO的内容到buf
				printf ("client: %s\n", buf);
		}
		exit (EXIT_SUCCESS);
	}
	return 0;
}

```

## 2个客户端进程通过服务端实现双向通信
 ReceiverID data 
client1.c
```c
/************************************************
*      Filename: client1.c
*        Author: litao.wang
*    Bug Report: 3284757626@qq.com
*   Description: 
*        Create: 2019-06-14 06:36:55
* Last Modified: 2019-07-18 16:13:17
*************************************************/
#include <stdio.h>
#include <stdlib.h>
#include <unistd.h>
#include <string.h>
#include <fcntl.h>
#include <sys/stat.h>
#include <sys/types.h>

#define FIFO_SERVER "fifo_server"
#define FIFO_CLIENT_1 "fifo_client1"

int main (void)
{
	mkfifo (FIFO_SERVER, 0644);		//注册FIFO
	mkfifo (FIFO_CLIENT_1, 0644);
	int ret_from_fork;
	ret_from_fork = fork ();
	if (ret_from_fork == -1)
	{
		perror ("fork");
		exit (EXIT_FAILURE);
	}
	else if (ret_from_fork == 0)  // child process 1: write
	{  
		int fifo_fd_write;
		fifo_fd_write = open (FIFO_SERVER, O_WRONLY);
		//打开FIFO_SERVER
		char buf[100];
		while (1)
		{
			memset (buf, 0, 100);
			buf[0] = '2';	//标识 说明数据时发给2的
			scanf ("%s", buf + 1);
			write (fifo_fd_write, buf, strlen (buf) + 1);
			//写数据统一写到FIFO_SERVER，由server统一处理
		}
		_exit (EXIT_SUCCESS);
	}
	else              			// parent process: read
	{
		int fifo_fd_read;
		fifo_fd_read = open (FIFO_CLIENT_1, O_RDONLY);
		//打开FIFO_CLIENT_1
		char buf[100];
		while (1)
		{
			memset (buf, 0, 100);
			if (read (fifo_fd_read, buf, 100) > 0)//从FIFO_CLIENT_1读数据
			{
				printf ("client2: %s\n", buf);
			}
		}
		exit (EXIT_SUCCESS);
	}
	return 0;
}

```
client2.c
```c
/************************************************
*      Filename: client2.c
*        Author: litao.wang
*    Bug Report: 3284757626@qq.com
*   Description: 
*        Create: 2019-06-14 06:36:55
* Last Modified: 2019-07-18 16:13:05
*************************************************/
#include <stdio.h>
#include <stdlib.h>
#include <unistd.h>
#include <string.h>
#include <fcntl.h>
#include <sys/stat.h>
#include <sys/types.h>

#define FIFO_SERVER "fifo_server"
#define FIFO_CLIENT_2 "fifo_client2"

int main (void)
{
	mkfifo (FIFO_SERVER, 0644);
	mkfifo (FIFO_CLIENT_2, 0644);
	int ret_from_fork;
	ret_from_fork = fork ();
	if (ret_from_fork == -1)
	{
		perror ("fork");
		exit (EXIT_FAILURE);
	}
	else if (ret_from_fork == 0)  // child process 2: write
	{  
		int fifo_fd_write;
		fifo_fd_write = open (FIFO_SERVER, O_WRONLY);
		//打开FIFO_SERVER
		char buf[100];
		while (1)
		{
			memset (buf, 0, 100);
			buf[0] = '1';	//标识说明数据时发给1的
			scanf ("%s", buf + 1);
			write (fifo_fd_write, buf, strlen (buf) + 1);
			//写数据统一写到FIFO_SERVER，由server统一处理
		}
		_exit (EXIT_SUCCESS);
	}
	else              			// parent process: read
	{
		int fifo_fd_read;
		fifo_fd_read = open (FIFO_CLIENT_2, O_RDONLY);
		//从FIFO_CLIENT_2读数据
		char buf[100];
		while (1)
		{
			memset (buf, 0, 100);
			if (read (fifo_fd_read, buf, 100) > 0)
				printf ("client1: %s\n", buf);
		}
		exit (EXIT_SUCCESS);
	}
	return 0;
}
```

server.c
```c
/************************************************
*      Filename: server.c
*        Author: litao.wang
*    Bug Report: 3284757626@qq.com
*   Description: 
*        Create: 2019-06-14 06:36:55
* Last Modified: 2019-07-18 19:09:29
*************************************************/
#include <stdio.h>
#include <stdlib.h>
#include <unistd.h>
#include <string.h>
#include <fcntl.h>
#include <sys/stat.h>
#include <sys/types.h>

#define FIFO_SERVER "fifo_server"
#define FIFO_CLIENT_1 "fifo_client1"
#define FIFO_CLIENT_2 "fifo_client2"

int main (void)
{
	mkfifo (FIFO_SERVER, 0644);		//注册FIFO
	mkfifo (FIFO_CLIENT_1, 0644);
	mkfifo (FIFO_CLIENT_2, 0644);
	
	int ret_from_fork;
	int buf_ready = 0;
	char public_buf[100];
		
	int fifo_fd_read;
	fifo_fd_read = open (FIFO_SERVER, O_RDONLY);
	memset (public_buf, 0, 100);

	int fifo_fd_write1;
	int fifo_fd_write2;
	fifo_fd_write1 = open (FIFO_CLIENT_1, O_WRONLY);//打开FIFO
	fifo_fd_write2 = open (FIFO_CLIENT_2, O_WRONLY);
	int read_len;
	while (1)
	{
		read_len = read (fifo_fd_read, public_buf, 100);
		if (read_len == -1)
		{
			perror ("read");
			exit (EXIT_FAILURE);
		}
		else if (read_len > 0)
		{
			printf ("%s\n", public_buf);
			if (public_buf[0] == '1')
				write (fifo_fd_write1, public_buf + 1, strlen (public_buf));
				//检测到1，往客户端1转发
			else if (public_buf[0] == '2')
				write (fifo_fd_write2, public_buf + 1, strlen (public_buf));
		}
		sleep (1);
	}
	return 0;
}
```

## 多个客户端
3个用户为例
SendID ReceiverID data 

readme
```c
usages:
	eg: client1 sent "hello" to client2
	process1: 2hello

text structure in server FIFO:
    sentID receiverID text
	12hello

```
server.c
```c
/************************************************
*      Filename: server.c
*        Author: litao.wang
*    Bug Report: 3284757626@qq.com
*   Description: 
*        Create: 2019-06-14 06:36:55
* Last Modified: 2019-07-18 19:20:58
*************************************************/
#include <stdio.h>
#include <stdlib.h>
#include <unistd.h>
#include <string.h>
#include <fcntl.h>
#include <sys/stat.h>
#include <sys/types.h>

#define FIFO_SERVER "fifo_server"
#define FIFO_CLIENT_1 "fifo_client1"
#define FIFO_CLIENT_2 "fifo_client2"
#define FIFO_CLIENT_3 "fifo_client3"

int main (void)
{
	mkfifo (FIFO_SERVER, 0644);		//创建4个管道
	mkfifo (FIFO_CLIENT_1, 0644);
	mkfifo (FIFO_CLIENT_2, 0644);
	mkfifo (FIFO_CLIENT_3, 0644);

	int ret_from_fork;
	int buf_ready = 0;
	char public_buf[100];
		
	int fd_fifo_read;
	fd_fifo_read = open (FIFO_SERVER, O_RDONLY);
	memset (public_buf, 0, 100);


	int fd_fifo_write1;
	int fd_fifo_write2;
	int fd_fifo_write3;
	fd_fifo_write1 = open (FIFO_CLIENT_1, O_WRONLY);
	fd_fifo_write2 = open (FIFO_CLIENT_2, O_WRONLY);
	fd_fifo_write3 = open (FIFO_CLIENT_3, O_WRONLY);

	int read_len;
	while (1)
	{
		read_len = read (fd_fifo_read, public_buf, 100);
		if (read_len == -1)
		{
			perror ("read");
			exit (EXIT_FAILURE);
		}
		else if (read_len > 0)
		{
			printf ("%s\n", public_buf);
			if (public_buf[1] == '1')	//接收者为1
			{
				public_buf[1] = public_buf[0]; // save sent ID
				//发送者的标志覆盖掉public_buf[1] 再从public_buf[1]开始发送
				write (fd_fifo_write1, public_buf + 1, strlen (public_buf));
			}
			else if (public_buf[1] == '2')
			{
				public_buf[1] = public_buf[0]; 
				write (fd_fifo_write2, public_buf + 1, strlen (public_buf));
			}
			else if (public_buf[1] == '3')
			{
				public_buf[1] = public_buf[0]; 
				write (fd_fifo_write3, public_buf + 1, strlen (public_buf));
			}
			else   // options
				continue;
		}
		sleep (1);
	}
	return 0;
}

```
client1.c
```c
/************************************************
*      Filename: client1.c
*        Author: litao.wang
*    Bug Report: 3284757626@qq.com
*   Description: 
*        Create: 2019-06-14 06:36:55
* Last Modified: 2019-07-18 18:27:45
*************************************************/
#include <stdio.h>
#include <stdlib.h>
#include <unistd.h>
#include <string.h>
#include <fcntl.h>
#include <sys/stat.h>
#include <sys/types.h>

#define FIFO_SERVER "fifo_server"
#define FIFO_CLIENT_1 "fifo_client1"

int main (void)
{
	mkfifo (FIFO_SERVER, 0644);		//注册FIFO
	mkfifo (FIFO_CLIENT_1, 0644);
	int ret_from_fork;
	ret_from_fork = fork ();
	if (ret_from_fork == -1)
	{
		perror ("fork");
		exit (EXIT_FAILURE);
	}
	else if (ret_from_fork == 0)  // child process 1: write
	{  
		int fd_fifo_write;
		fd_fifo_write = open (FIFO_SERVER, O_WRONLY);
		char buf[100];
		while (1)
		{
			memset (buf, 0, 100);
			buf[0] = '1';	//标识发送者为1
			scanf ("%s", buf + 1);	//从键盘输入要发送的内容
			write (fd_fifo_write, buf, strlen (buf) + 1);
			//buf写到管道FIFO_SERVER
		}
		_exit (EXIT_SUCCESS);
	}
	else              			// parent process: read
	{
		int fd_fifo_read;
		fd_fifo_read = open (FIFO_CLIENT_1, O_RDONLY);
		char buf[100];
		while (1)
		{
			memset (buf, 0, 100);
			if (read (fd_fifo_read, buf, 100) > 0)
			{
				//从FIFO_SERVER 读内容到buf
				printf ("client%c: %s\n", buf[0], buf + 1);
				//buf[0]表示消息的发送者
			}
		}
		exit (EXIT_SUCCESS);
	}
	return 0;
}

```