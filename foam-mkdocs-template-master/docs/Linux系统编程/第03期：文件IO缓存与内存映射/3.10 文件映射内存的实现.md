# 3.10 文件映射内存的实现
##  结构体：task_struct
task_struct 表示一个进程
进程之间链接成一个链表

```c
struct task_struct {
volatile long state; 
void *stack;
int prio, static_prio, normal_prio;
unsigned int rt_priority;
const struct sched_class *sched_class;
struct sched_entity se;
cpumask_t cpus_allowed;
struct list_head tasks;
struct mm_struct *mm, *active_mm;	//mm_struct
u32 vmacache_seqnum;
int exit_state;
int exit_code, exit_signal;
//...
}
```

## mm_struct
描述 Linux进程虚拟地址
```c
struct mm_struct {
struct vm_area_struct *mmap; /* list of VMAs */	//vm_area_struct
struct rb_root mm_rb;
u32 vmacache_seqnum; /* per-thread vmacache */
unsigned long mmap_base;  /* base of mmap area */
unsigned long mmap_legacy_base; /* base of mmap area in bottom-up allocations */
unsigned long task_size;  /* size of task vm space */
unsigned long highest_vm_end; /* highest vma end address */
pgd_t * pgd;
atomic_t mm_users; /* How many users with user space? */
atomic_t mm_count; /* How many references to "struct mm_struct" (users count as 1) */
atomic_long_t nr_ptes;  /* PTE page table pages */
int map_count;  /* number of VMAs */
spinlock_t page_table_lock;  /* Protects page tables and some counters */
struct rw_semaphore mmap_sem;
}
```

## vm_area_struct
描述每一个内存区域
双向循环链表
```c
struct vm_area_struct {
/* The first cache line has the info for VMA tree walking. */
unsigned long vm_start;  /* Our start address within vm_mm. */ 起始地址
unsigned long vm_end;  /* The first byte after our end address	结束地址
within vm_mm. */
struct vm_area_struct *vm_next, *vm_prev; /* linked list of VM areas per task*/
//前一个和后一个vm_area_struct的指针

struct rb_node vm_rb;
unsigned long rb_subtree_gap;
struct mm_struct *vm_mm;  /* The address space we belong to. */
pgprot_t vm_page_prot;  /* Access permissions of this VMA. */
unsigned long vm_flags;  /* Flags, see mm.h. */
const struct vm_operations_struct *vm_ops;
unsigned long vm_pgoff;  /* Offset (within vm_file) in PAGE_SIZE
units, *not* PAGE_CACHE_SIZE */
struct file * vm_file; /* File we map to (can be NULL). */
void * vm_private_data;  /* was vm_pte (shared mem) */
…
};
```
## 磁盘文件的逻辑地址与Linux进程虚拟地址建立关联
减少了页缓存到用户空间的拷贝
减少了标准的io空间到用户buffer的拷贝
减少了系统调用
![[Pasted image 20201004195748.png]]
