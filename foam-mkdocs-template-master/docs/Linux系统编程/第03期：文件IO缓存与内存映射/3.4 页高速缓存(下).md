# 3.4 页高速缓存(下)
## 页缓存对象：属性
```c
struct address_space {
struct inode  *host;  /* owner: inode, block_device */
struct radix_tree_root page_tree; /* radix tree of all pages */
spinlock_t tree_lock; /* and lock protecting it */
atomic_t i_mmap_writable;/* count VM_SHARED mappings */
struct rb_root  i_mmap; /* tree of private and shared mappings */
struct rw_semaphore i_mmap_rwsem;  /* protect tree, count, list */
/* Protected by tree_lock together with the radix tree */
unsigned long  nrpages;  /* number of total pages */
unsigned long  nrshadows;  /* number of shadow entries */
pgoff_t  writeback_index;/* writeback starts here */
const struct address_space_operations *a_ops;  /* methods */
unsigned long  flags;  /* error bits/gfp mask */
spinlock_t private_lock;  /* for use by the address_space */
struct list_head  private_list;  /* ditto */
void  *private_data;  /* ditto */
} ; //通过该对象，可以将文件系统、内存管理系统进行关联
```
## 页缓存对象：方法
```c
struct address_space_operations {
int (*writepage)(struct page *page, struct writeback_control *wbc);
int (*readpage)(struct file *, struct page *);
int (*writepages)(struct address_space *, struct writeback_control *);
int (*set_page_dirty)(struct page *page);
int (*readpages)(struct file *filp, struct address_space *mapping,
struct list_head *pages, unsigned nr_pages);
…
sector_t (*bmap)(struct address_space *, sector_t);
void (*invalidatepage) (struct page *, unsigned int, unsigned int);
int (*releasepage) (struct page *, gfp_t);
void (*freepage)(struct page *);
ssize_t (*direct_IO)(struct kiocb *, struct iov_iter *iter, loff_t offset);
}; // 文件位置偏移  页偏移量  文件系统块号：block  磁盘扇区号
```
## 页缓存对象：物理页
```c
struct page {
unsigned long flags;
union {
struct address_space *mapping;
void *s_mem;  /* slab first object */
};
union {
struct list_head lru; 
struct {  /* slub per cpu partial pages */
struct page *next;  /* Next partial slab */
short int pages;
short int pobjects;
};
union {
unsigned long private;
spinlock_t ptl;
struct kmem_cache *slab_cache;
};
} //一个页可以是文件页缓存、可以是交换缓存、也可以是普通内存
```

## 读文件基本流程
数据结构关联：inode->i_mapping指向address_space对象
数据结构关联：address_space->host指向inode
数据结构关联：page->mapping指向页缓存owner的address_space
系统调用传参：文件描述符 + 文件位置偏移
系统找到文件的address_space，根据偏移量到页缓存中查找page
若查找到，返回数据到用户空间
若没查到，内核新建一个page并加入页缓存，数据从磁盘载入该页
调用readpage方法将数据返回给用户空间
## 读文件示例
![[Pasted image 20201004184520.png]]
## 写文件基本流程
数据结构关联：inode->i_mapping指向address_space对象
数据结构关联：address_space->host指向inode
数据结构关联：page->mapping指向页缓存owner的address_space
系统调用传参：文件描述符 + 文件位置偏移
系统找到文件的address_space，根据偏移量到页缓存中查找page
若查找到，将数据写入到该页缓存中，该页成为“脏页”
若没查到，从缓存中分配空闲页，数据从用户空间写入该页
当数据满足一定空间或时间阈值，将脏页中的数据回写到磁盘
守护进程：pdflush