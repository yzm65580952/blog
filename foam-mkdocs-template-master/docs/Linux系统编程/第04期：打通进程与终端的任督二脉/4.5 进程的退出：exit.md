# 4.5 进程的退出：exit
## exit函数
1.  POSIX标准和ANSI C定义的标准函数
#include <stdlib.h>
其实是对系统调用_exit的封装
2. 函数原型：void exit (int status);
3. 函数功能：终止当前进程
4. 参数说明：用于标识进程的退出状态，shell或父进程可以获取该值
0：表示进程正常退出
-1/1：表示进程退出异常
2~n：用户可自定义

## exit执行流程
1. 调用退出处理程序(通过atexit、on_exit注册的函数)
2. 刷新stdio流缓冲区
3. 使用由status提供的值执行_exit系统调用函数
关闭进程打开的文件描述符、释放进程持有的文件锁
关闭进程打开的信号量、消息队列
取消该进程通过mmap创建的内存映射

## atexit/on_exit 退出处理程序
在exit退出后可以自动执行<font color=red>用户注册的退出处理程序</font>
执行顺序与注册顺序相反
函数原型：int atexit (void (*function)(void));
函数原型：int on_exit (void (*function)(int , void *), void *arg);

```c

/************************************************
*      Filename: atexit.c
*        Author: litao.wang
*    Bug Report: 3284757626@qq.com
*   Description: 
*        Create: 2019-03-12 16:37:08
* Last Modified: 2019-03-13 08:21:53
*************************************************/
#include <stdio.h>
#include <stdlib.h>

static void exit_process1 (void)
{
	printf ("exit process func1\n");
}

static void exit_process2 (void)
{
	printf ("exit process func2\n");
}

static void on_exit_process (int exit_status, void *arg)
{
	printf ("on_exit_process called:status = %d, args=%d\n", exit_status, (int)arg);
}

int main (void)
{
	if (atexit (exit_process1) != 0)
		perror ("atexit 1");
	if (atexit (exit_process2) != 0)
		perror ("atexit 2");
	if (on_exit (on_exit_process, (void *) 20) != 0)
		perror ("on_exit");
	exit (5);
//	return 0;
}

```

## return与exit的区别
1. exit用来终止当前进程，将控制权交给操作系统
2. return用来退出当前函数，销毁栈帧，返回到上级函数执行
3. 终止进程：
正常退出：exit、_exit、从main函数return
异常退出：调用abort、信号ctrl + C

##  main()函数可以通过return或exit终止进程
main()函数return后，为什么相当于调用exit()，进程就退出了？


 ## exit_group函数
函数原型： void exit_group (int status);
exit：退出当前进程process
exit_group：退出一个进程中所有threads
Linux系统特有的系统调用，不属于POSIX标准

## exit的安全性
fork之后、exec之前，使用exit是不安全的
很多资源还是共享的(如文件描述符、缓冲区)